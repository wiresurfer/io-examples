{"version":3,"sources":["modbus-flex-server.js"],"names":["module","exports","RED","require","install","coreServer","mbBasics","message","payload","registers","config","nodes","createNode","this","_require","VMScript","logEnabled","internalDebugLog","serverAddress","serverPort","parseInt","responseDelay","ModbusFlexServer","delayUnit","unitId","minAddress","VM","splitAddress","name","funcGetCoil","compile","funcGetDiscreteInput","funcGetInputRegister","funcGetHoldingRegister","funcSetCoil","funcSetRegister","showErrors","verbose","node","bufferFactor","verboseLogging","alloc","settings","Buffer","registersBufferSize","coilsBufferSize","coils","vector","vm","sandbox","buildMessage","msg","type","disableMsgOutput","slice","send","run","startServer","modbusServer","ModbusRTU","ServerTCP","host","port","debug","unitID","err","error","on","close","_server","sock","stringify","address","remoteAddress","remotePort","setNodeStatusTo","showStatusActivities","setNodeDefaultStatus","writeToFlexServerMemory"],"mappings":"aAaAA,OAAOC,QAAU,SAAUC,GAEzBC,QAAQ,sBAAsBC,UAFhCJ,IAAOC,EAAUE,QAAUD,iBACzBG,EAAAF,QAAA,6BAIMG,EAAWH,QAAQ,mBAHzBA,EAAQA,QAAsBC,QAAtBD,CAAR,6BA6IuBI,IAAcC,EAAAA,MAAAA,aAAcC,qBA5InD,SAA0BC,GAMxBR,EAAIS,MAAMC,WAAWC,KAAMH,GANH,IAAAI,EACCX,QAAA,OAArBE,EADoBS,EACpBT,GAAUU,EADUD,EACVC,SAChBF,KAAMP,KAAQI,EAAGP,KAQfU,KAAKG,WAAaN,EAAOM,WAP3BH,KAAMI,cAAmBd,EAAOe,eAAU,UASxCL,KAAKM,WAAaC,SAASV,EAAOS,YAPpCN,KAAAQ,cAASC,SAATZ,EAAmCW,eACjCnB,KAAIS,UAAMC,EAAWW,UASrBV,KAAKW,OAASJ,SAASV,EAAOc,SAAW,EAVRX,KAAAY,WAERtB,SAAQO,EAFAe,aAAA,EAAAZ,KAEzBa,aAFyBN,SAAAV,EAAAiB,eAAA,IAAAd,KAErBE,WAFqBL,EAErBK,WAEZF,KAAKe,YAAcA,IAAnBb,EAAAL,EAAAmB,aAAAC,UACAjB,KAAKG,qBAAoBA,IAAAA,EAAzBN,EAAAqB,sBAAAD,UACAjB,KAAKK,qBAAuBA,IAAAA,EAAPR,EAAwBsB,sBAA7CF,UACAjB,KAAKM,uBAAsBT,IAAOS,EAAAA,EAAlCc,wBAAAH,UAEAjB,KAAKU,YAAYb,IAAMK,EAACQ,EAAxBW,aAAAJ,UACAjB,KAAKW,gBAAkBd,IAAAA,EAADA,EAAtByB,iBAAAL,UAEAjB,KAAKc,iBAAeP,EACpBP,KAAKuB,eAAa1B,EAAO0B,SAAzBC,QAGA,IAAKN,EAAAA,KACLO,EAAKN,aAAAA,EAAuBO,aAG5BD,EAAKJ,gBAAkBnB,SAASL,EAAOwB,gBAAaJ,EAApDS,cACAD,EAAKH,oBAAsBpB,SAASL,EAAOyB,oBAAiBL,EAA5DS,cAGAD,EAAKE,MAAAA,OAALC,MAA0BC,EAAAA,gBAA1B,GAEAJ,EAAMA,UAANK,OAAAF,MAAAH,EAAAM,oBAAA,GAGAN,EAAKO,aAAL,KAGAP,EAAKQ,gBAAQ,cAAkBD,GAY/BP,EAAKS,OAAS,GAEd,IAAQC,EAAG,IAAAtB,EAAO,CAChBuB,QAAS,CAAAX,KAAAA,KA6EN,SAAAY,EAAAC,GAQH,MAAO,CAPL,CAAAC,KAAQ,UAASC,QAAAA,EAAjB7C,QAAmC8B,EAAA7B,UAAA6C,MAAAhB,EAAAX,aAAAtB,EAAAkC,eACjCD,CAAAA,KAAKiB,QAAKL,QAAaC,EAAvB3C,QAAA8B,EAAAQ,MAAAQ,MAAA,EAAAhB,EAAAX,aAAAtB,EAAAkC,eACD,CAAAa,KAAA,QAAA7C,QAAA4C,EAAA3C,QAAA8B,EAAA7B,UAAA6C,MAAA,EAAAhB,EAAAX,aAAAtB,EAAAkC,eACF,CAAAa,KAAA,WAAA7C,QAAA4C,EAAA3C,QAAA8B,EAAAQ,MAAAQ,MAAAhB,EAAAX,aAAAtB,EAAAkC,eAbH,CAAA/B,QAAA,UAAA4C,KAAA,UAAA7C,QAAA4C,IArEkBH,EAAlBQ,IAAA,yBAAA9C,EAAAmB,aAIAmB,EAAGQ,IAAI,kCAAkC3B,EAAAA,sBACzCmB,EAAGQ,IAAI,kCAAoC9C,EAAOqB,sBAClDiB,EAAGQ,IAAI,oCAAoC9C,EAAOsB,wBAGlDgB,EAAGQ,IAAI,yBAA2B9C,EAAOwB,aACzCc,EAAGQ,IAAI,6BAA+B9C,EAAOyB,iBAE7CG,EAAKmB,YAAc,WACjB,IACE,GAA0B,OAAtBnB,EAAKoB,aAAuB,CAC9B,IACEpB,EAAKoB,aAAe,IAAIC,EAAUC,UAAUtB,EAAKS,OAAQ,CACvDc,KAAMvB,EAAKpB,cACX4C,KAAMxB,EAAKnB,WACX4C,MAAOzB,EAAKtB,WACZgD,OAAQ1B,EAAKd,SAEf,MAAOyC,GACP3B,EAAK4B,MAAMD,EAAK,CAAAzD,QAAA,0EACjB8B,EAAAoB,aAAAS,GAAA,cAAA,SAAAF,GAGChD,EAAiBgD,EAAI1D,SADlBmD,EAAAA,YACHzC,EAAAA,KAAAA,GACAX,EAAS8B,gBAAY,QAAAE,GAEpBA,EAAAoB,aAAAU,MAAA,WAIC9B,EAAKmB,kBACNnB,EAFDoB,aAAAW,QAAAF,GAAA,aAAA,SAAAG,GAPFrD,EAAA,wCAcMqD,GAFFrD,EAAcoD,gCAAmCC,KAAMC,UAAAD,EAAAE,WAAA,SAAAF,EAAAG,cAAA,IAAAH,EAAAI,YAKzDpE,EAASqE,gBAAgB,SAAUrC,KAIlCA,EAAKsC,sBAJNtE,EAAAA,qBAAyBgC,GAE5B,MAAA2B,GAMDhD,EAAiBgD,EAAI1D,SAJjB+B,EAAKF,YACP9B,EAAAA,KAASuE,GAEXvE,EAAO2D,gBAAK,QAAA3B,GAES,MAArBA,EAAIA,cACFA,EAAA,4CAAAA,EAAApB,cAAA,IAAAoB,EAAAnB,YACDb,EAAAqE,gBAAA,cAAArC,KACDhC,EAASqE,kCACVrE,EAAAqE,gBAAA,QAAArC,KAIChC,EAAAA,cAEAW,EAAAA,GAAAA,QAAAA,SAAiBkC,GACjB7C,EAASqE,qBAAyBrC,IACnCjC,EAAAyE,wBAAAxC,EAAAa,GApDH,IAAAA,EAAA3C,QAAA6C,kBA6DMf,EAAKiB,KAAKL,EAAaC,MAHvB9C,EAAAA,YACFA,EAAAA,MAAWyE,gDAAX3B,GACIA,EAAI3C,QAAQ6C,kBACdf,EAAKiB,KAAKL,EAAaC,OAcvBC,EAAAA,GAAI,QAAE,WAAW7C,EAAOoE,gBAA1B,SAAArC,GAAiC9B,EAAOkD,aAAOjD,SAD1C6B,EAELoB,aAAAW,QAAAD,QAAiB7D,EAAAA,aAAjB,SACA,MACA0D,GAAEb,EAAMa,EAAR1D","file":"../modbus-flex-server.js","sourcesContent":["/**\n Copyright (c) 2017,2018,2019,2020 Klaus Landsdorf (https://bianco-royal.com/)\n All rights reserved.\n node-red-contrib-modbus - The BSD 3-Clause License\n\n @author <a href=\"mailto:klaus.landsdorf@bianco-royal.de\">Klaus Landsdorf</a> (Bianco Royal)\n **/\n/**\n * Modbus Server node.\n * @module NodeRedModbusServer\n *\n * @param RED\n */\nmodule.exports = function (RED) {\n  'use strict'\n  require('source-map-support').install()\n  const ModbusRTU = require('modbus-serial')\n  const coreServer = require('./core/modbus-server-core')\n  const mbBasics = require('./modbus-basics')\n  const internalDebugLog = require('debug')('contribModbus:flex:server')\n\n  function ModbusFlexServer (config) {\n    RED.nodes.createNode(this, config)\n    const { VM, VMScript } = require('vm2')\n\n    this.name = config.name\n    this.logEnabled = config.logEnabled\n    this.serverAddress = config.serverAddress || '0.0.0.0'\n    this.serverPort = parseInt(config.serverPort)\n    this.responseDelay = parseInt(config.responseDelay)\n    this.delayUnit = config.delayUnit\n    this.unitId = parseInt(config.unitId) || 1\n    this.minAddress = parseInt(config.minAddress) || 0\n    this.splitAddress = parseInt(config.splitAddress) || 10000\n    this.showErrors = config.showErrors\n\n    this.funcGetCoil = new VMScript(config.funcGetCoil).compile()\n    this.funcGetDiscreteInput = new VMScript(config.funcGetDiscreteInput).compile()\n    this.funcGetInputRegister = new VMScript(config.funcGetInputRegister).compile()\n    this.funcGetHoldingRegister = new VMScript(config.funcGetHoldingRegister).compile()\n\n    this.funcSetCoil = new VMScript(config.funcSetCoil).compile()\n    this.funcSetRegister = new VMScript(config.funcSetRegister).compile()\n\n    this.internalDebugLog = internalDebugLog\n    this.verboseLogging = RED.settings.verbose\n\n    const node = this\n    node.bufferFactor = coreServer.bufferFactor\n\n    node.coilsBufferSize = parseInt(config.coilsBufferSize * coreServer.bufferFactor)\n    node.registersBufferSize = parseInt(config.registersBufferSize * coreServer.bufferFactor)\n\n    node.coils = Buffer.alloc(node.coilsBufferSize, 0)\n    node.registers = Buffer.alloc(node.registersBufferSize, 0)\n\n    node.modbusServer = null\n\n    mbBasics.setNodeStatusTo('initialized', node)\n\n    //     1...10000*  address - 1      Coils (outputs)    0   Read/Write\n    // 10001...20000*  address - 10001  Discrete Inputs    01  Read\n    // 30001...40000*  address - 30001  Input Registers    04  Read\n    // 40001...50000*  address - 40001  Holding Registers  03  Read/Write\n\n    node.vector = {}\n\n    const vm = new VM({\n      sandbox: { node }\n    })\n\n    vm.run('node.vector.getCoil = ' + config.funcGetCoil)\n    vm.run('node.vector.getDiscreteInput = ' + config.funcGetDiscreteInput)\n    vm.run('node.vector.getInputRegister = ' + config.funcGetInputRegister)\n    vm.run('node.vector.getHoldingRegister = ' + config.funcGetHoldingRegister)\n\n    vm.run('node.vector.setCoil = ' + config.funcSetCoil)\n    vm.run('node.vector.setRegister = ' + config.funcSetRegister)\n\n    node.startServer = function () {\n      try {\n        if (node.modbusServer === null) {\n          try {\n            node.modbusServer = new ModbusRTU.ServerTCP(node.vector, {\n              host: node.serverAddress,\n              port: node.serverPort,\n              debug: node.logEnabled,\n              unitID: node.unitId\n            })\n          } catch (err) {\n            node.error(err, { payload: 'server net error -> for port 502 on unix, you have to be a super user' })\n          }\n\n          node.modbusServer.on('socketError', function (err) {\n            internalDebugLog(err.message)\n            if (node.showErrors) {\n              node.warn(err)\n            }\n            mbBasics.setNodeStatusTo('error', node)\n\n            node.modbusServer.close(function () {\n              node.startServer()\n            })\n          })\n\n          node.modbusServer._server.on('connection', function (sock) {\n            internalDebugLog('Modbus Flex Server client connection')\n            if (sock) {\n              internalDebugLog('Modbus Flex Server client to ' + JSON.stringify(sock.address()) + ' from ' + sock.remoteAddress + ' ' + sock.remotePort)\n            }\n            mbBasics.setNodeStatusTo('active', node)\n          })\n        }\n\n        if (!node.showStatusActivities) {\n          mbBasics.setNodeDefaultStatus(node)\n        }\n      } catch (err) {\n        internalDebugLog(err.message)\n        if (node.showErrors) {\n          node.warn(err)\n        }\n        mbBasics.setNodeStatusTo('error', node)\n      }\n\n      if (node.modbusServer != null) {\n        internalDebugLog('Modbus Flex Server listening on modbus://' + node.serverAddress + ':' + node.serverPort)\n        mbBasics.setNodeStatusTo('initialized', node)\n      } else {\n        internalDebugLog('Modbus Flex Server isn\\'t ready')\n        mbBasics.setNodeStatusTo('error', node)\n      }\n    }\n\n    node.startServer()\n\n    node.on('input', function (msg) {\n      if (coreServer.isValidMemoryMessage(msg)) {\n        coreServer.writeToFlexServerMemory(node, msg)\n        if (msg.payload.disableMsgOutput !== 1) {\n          node.send(buildMessage(msg))\n        }\n      } else {\n        if (node.showErrors) {\n          node.error('Is Not A Valid Memory Write Message To Server', msg)\n        }\n        if (!msg.payload.disableMsgOutput) {\n          node.send(buildMessage(msg))\n        }\n      }\n    })\n\n    function buildMessage (msg) {\n      return [\n        { type: 'holding', message: msg, payload: node.registers.slice(node.splitAddress * coreServer.bufferFactor) },\n        { type: 'coils', message: msg, payload: node.coils.slice(0, node.splitAddress * coreServer.bufferFactor) },\n        { type: 'input', message: msg, payload: node.registers.slice(0, node.splitAddress * coreServer.bufferFactor) },\n        { type: 'discrete', message: msg, payload: node.coils.slice(node.splitAddress * coreServer.bufferFactor) },\n        { payload: 'request', type: 'message', message: msg }\n      ]\n    }\n\n    node.on('close', function () {\n      mbBasics.setNodeStatusTo('closed', node)\n      if (node.modbusServer._server) {\n        node.modbusServer._server.close()\n      }\n      node.modbusServer = null\n    })\n  }\n\n  try {\n    RED.nodes.registerType('modbus-flex-server', ModbusFlexServer)\n  } catch (err) {\n    internalDebugLog(err.message)\n  }\n}\n"]}