"use strict";module.exports=function(s){require("source-map-support").install();var i=require("./modbus-basics"),o=require("./core/modbus-core"),t=require("./core/modbus-io-core"),d=require("debug")("contribModbus:flex:getter");s.nodes.registerType("modbus-flex-getter",function(e){s.nodes.createNode(this,e),this.name=e.name,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.connection=null,this.useIOFile=e.useIOFile,this.ioFile=s.nodes.getNode(e.ioFile),this.useIOForPayload=e.useIOForPayload,this.logIOActivities=e.logIOActivities,this.emptyMsgOnFail=e.emptyMsgOnFail,this.keepMsgProperties=e.keepMsgProperties,this.internalDebugLog=d,this.verboseLogging=s.settings.verbose;var a=this;a.bufferMessageList=new Map,i.setNodeStatusTo("waiting",a);var r=s.nodes.getNode(e.server);r&&(r.registerForModbus(a),i.initModbusClientEvents(a,r),a.onModbusReadDone=function(e,s){a.showStatusActivities&&i.setNodeStatusTo("reading done",a),a.send(t.buildMessageWithIO(a,e.data,e,s)),a.emit("modbusFlexGetterNodeDone")},a.errorProtocolMsg=function(e,s){i.logMsgError(a,e,s),i.sendEmptyMsgOnFail(a,e,s)},a.onModbusReadError=function(e,s){a.internalDebugLog(e.message);var t=o.getOriginalMessage(a.bufferMessageList,s);a.errorProtocolMsg(e,t),i.setModbusError(a,r,e,t),a.emit("modbusFlexGetterNodeError")},a.prepareMsg=function(e){return"string"==typeof e.payload&&(e.payload=JSON.parse(e.payload)),e.payload.fc=parseInt(e.payload.fc)||3,e.payload.unitid=parseInt(e.payload.unitid),e.payload.address=parseInt(e.payload.address)||0,e.payload.quantity=parseInt(e.payload.quantity)||1,e},a.isValidModbusMsg=function(e){var s=!0;return Number.isInteger(e.payload.fc)&&1<=e.payload.fc&&e.payload.fc<=4||(a.error("FC Not Valid",e),s&=!1),!s||Number.isInteger(e.payload.address)&&0<=e.payload.address&&e.payload.address<=65535||(a.error("Address Not Valid",e),s&=!1),!s||Number.isInteger(e.payload.quantity)&&1<=e.payload.quantity&&e.payload.quantity<=65535||(a.error("Quantity Not Valid",e),s&=!1),s},a.buildNewMessageObject=function(e,s){var t=o.getObjectId();return{topic:s.topic||e.id,messageId:t,payload:{value:s.payload.value||s.value,unitid:s.payload.unitid,fc:s.payload.fc,address:s.payload.address,quantity:s.payload.quantity,emptyMsgOnFail:e.emptyMsgOnFail,keepMsgProperties:e.keepMsgProperties,messageId:t}}},a.on("input",function(e){if(!i.invalidPayloadIn(e)&&r.client){var s=Object.assign({},e);try{var t,o=a.prepareMsg(s);a.isValidModbusMsg(o)&&(t=a.buildNewMessageObject(a,o),a.bufferMessageList.set(t.messageId,i.buildNewMessage(a.keepMsgProperties,o,t)),r.emit("readModbus",t,a.onModbusReadDone,a.onModbusReadError))}catch(e){a.errorProtocolMsg(e,s)}a.showStatusActivities&&i.setNodeStatusTo(r.actualServiceState,a)}}),a.on("close",function(e){i.setNodeStatusTo("closed",a),a.bufferMessageList.clear(),r.deregisterForModbus(a.id,e)}),a.showStatusActivities||i.setNodeDefaultStatus(a))})};
//# sourceMappingURL=maps/modbus-flex-getter.js.map
