"use strict";module.exports=function(o){require("source-map-support").install();var i=require("jsmodbus"),n=require("net"),a=require("./core/modbus-server-core"),u=require("./modbus-basics"),l=require("debug")("contribModbus:server");try{o.nodes.registerType("modbus-server",function(e){o.nodes.createNode(this,e),this.name=e.name,this.logEnabled=e.logEnabled,this.hostname=e.hostname||"0.0.0.0",this.serverPort=parseInt(e.serverPort),this.responseDelay=parseInt(e.responseDelay)||1,this.delayUnit=e.delayUnit,this.coilsBufferSize=parseInt(8*e.coilsBufferSize),this.holdingBufferSize=parseInt(8*e.holdingBufferSize),this.inputBufferSize=parseInt(8*e.inputBufferSize),this.discreteBufferSize=parseInt(8*e.discreteBufferSize),this.showErrors=e.showErrors,this.internalDebugLog=l,this.verboseLogging=o.settings.verbose;var r=this;r.netServer=null,r.modbusServer=null,u.setNodeStatusTo("initialized",r);var s="warn";o.settings.verbose&&(s="debug");try{r.netServer=new n.Server,r.modbusServer=new i.server.TCP(r.netServer,{logLabel:"ModbusServer",logLevel:s,logEnabled:r.logEnabled,responseDelay:u.calc_rateByUnit(r.responseDelay,r.delayUnit),coils:Buffer.alloc(r.coilsBufferSize,0),holding:Buffer.alloc(r.holdingBufferSize,0),input:Buffer.alloc(r.inputBufferSize,0),discrete:Buffer.alloc(r.discreteBufferSize,0)}),r.modbusServer.on("connection",function(e){l("Modbus Server client connection"),e&&e.socket&&l("Modbus Server client to "+JSON.stringify(e.socket.address())+" from "+e.socket.remoteAddress+" "+e.socket.remotePort),u.setNodeStatusTo("active",r)}),r.netServer.listen(r.serverPort,r.hostname,function(){l("Modbus Server listening on modbus://"+r.hostname+":"+r.serverPort),u.setNodeStatusTo("initialized",r)}),r.showStatusActivities||u.setNodeDefaultStatus(r)}catch(e){l(e.message),r.showErrors&&r.warn(e),u.setNodeStatusTo("error",r)}function t(e){return[{type:"holding",message:e,payload:r.modbusServer.holding},{type:"coils",message:e,payload:r.modbusServer.coils},{type:"input",message:e,payload:r.modbusServer.input},{type:"discrete",message:e,payload:r.modbusServer.discrete},{payload:"request",type:"message",message:e}]}r.on("input",function(e){a.isValidMemoryMessage(e)?a.writeToServerMemory(r,e):r.showErrors&&r.error("Is Not A Valid Memory Write Message To Server",e),e.payload.disableMsgOutput||r.send(t(e))}),r.on("close",function(e){u.setNodeStatusTo("closed",r),r.netServer&&r.netServer.close(function(){l("Modbus Server closed"),e()}),r.modbusServer=null})})}catch(e){l(e.message)}};
//# sourceMappingURL=maps/modbus-server.js.map
