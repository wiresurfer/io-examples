"use strict";module.exports=function(i){require("source-map-support").install();var t=require("./modbus-basics"),o=require("./core/modbus-queue-core"),s=require("debug")("contribModbus:queue");i.nodes.registerType("modbus-queue-info",function(e){i.nodes.createNode(this,e),this.name=e.name,this.topic=e.topic,this.unitid=parseInt(e.unitid)||1,this.lowLowLevel=parseInt(e.lowLowLevel),this.lowLevel=parseInt(e.lowLevel),this.highLevel=parseInt(e.highLevel),this.highHighLevel=parseInt(e.highHighLevel),this.errorOnHighLevel=e.errorOnHighLevel,this.queueReadIntervalTime=e.queueReadIntervalTime||1e3,this.showStatusActivities=e.showStatusActivities,this.updateOnAllQueueChanges=e.updateOnAllQueueChanges,this.updateOnAllUnitQueues=e.updateOnAllUnitQueues,this.internalDebugLog=s;var n=this;n.queueReadInterval=null,n.updateStatusRrunning=!1,n.unitsWithQueue=new Map,t.setNodeStatusTo("waiting",n);var a=i.nodes.getNode(e.server);a&&(a.registerForModbus(n),n.initUnitQueueStates=function(){for(var e=0;e<256;e+=1)n.unitsWithQueue.set(e,{}),n.resetStates(e)},n.resetStates=function(e){var t=n.unitsWithQueue.get(e);t.lowLowLevelReached=!0,t.lowLevelReached=!1,t.highLevelReached=!1,t.highHighLevelReached=!1},n.initUnitQueueStates(),n.checkLowLevelReached=function(e,t,u){var i,n=e.unitsWithQueue.get(u);!n.lowLevelReached&&t>e.lowLowLevel&&t<e.lowLevel&&(n.lowLevelReached=!0,i={payload:Date.now(),topic:e.topic,state:"low level reached",unitid:u,modbusClientName:a.name,bufferCommandListLength:t},e.send(i))},n.checkHighLevelReached=function(e,t,u){var i,n=e.unitsWithQueue.get(u);!n.highLevelReached&&t>e.lowLevel&&t>e.highLevel&&(n.highLevelReached=!0,i={payload:Date.now(),topic:e.topic,state:"high level reached",unitid:u,modbusClientName:a.name||a.id,highLevel:e.highLevel,bufferCommandListLength:t},e.errorOnHighLevel?e.error(new Error("Queue High Level Reached"),i):e.warn(i),e.send(i))},n.checkHighHighLevelReached=function(e,t,u){var i,n=e.unitsWithQueue.get(u);!n.highHighLevelReached&&t>e.highLevel&&t>e.highHighLevel&&(n.highHighLevelReached=!0,i={payload:Date.now(),topic:e.topic,state:"high high level reached",unitid:u,modbusClientName:a.name||a.id,highLevel:e.highLevel,highHighLevel:e.highHighLevel,bufferCommandListLength:t},e.error(new Error("Queue High High Level Reached"),i),e.send(i))},n.getStatusSituationFillColor=function(e){var t=n.unitsWithQueue.get(e),u="blue";return t.lowLevelReached&&(u="green"),t.highLevelReached&&(u=n.errorOnHighLevel?"red":"yellow"),t.highHighLevelReached&&(u="red"),u},n.setNodeStatusByActivity=function(e,t){n.showStatusActivities&&n.status({fill:n.getStatusSituationFillColor(n.unitid),shape:"ring",text:e?"active unit "+t+" queue items: "+e:"active (Unit-Id: "+t+") empty"})},n.readFromQueue=function(){if(!n.updateStatusRrunning){var i=n.unitid<1||255<n.unitid?1:n.unitid;if(a.bufferCommands)return new Promise(function(e,t){try{n.updateStatusRrunning=!0;var u=a.bufferCommandList.get(i).length;n.checkQueueStates(u,i),n.setNodeStatusByActivity(u,i),n.updateStatusRrunning=!1,e()}catch(e){n.updateStatusRrunning=!1,t(e)}});n.showStatusActivities&&n.setNodeStatusByActivity(null,i)}},n.checkQueueStates=function(e,t){!n.unitsWithQueue.get(t).lowLowLevelReached&&e<n.lowLowLevel&&n.resetStates(t),n.checkLowLevelReached(n,e,t),n.checkHighLevelReached(n,e,t),n.checkHighHighLevelReached(n,e,t)},n.readFromAllUnitQueues=function(){if(!n.updateStatusRrunning)return a.bufferCommands?new Promise(function(e,t){try{n.updateStatusRrunning=!0;for(var u,i=0;i<256;i+=1)(u=a.bufferCommandList.get(i).length)&&n.checkQueueStates(u,i);n.updateStatusRrunning=!1,e()}catch(e){n.updateStatusRrunning=!1,t(e)}}):void 0},n.registerModbusQueueActionsToNode=function(e){n.updateOnAllQueueChanges&&a.on("mbqueue",e),a.on("mbactive",e),a.on("mbinit",e),a.on("mbconnected",e),a.on("mberror",e),a.on("mbclosed",e),n.queueReadInterval=setInterval(e,n.queueReadIntervalTime)},n.removeModbusQueueActionsFromNode=function(e){a.removeListener("mbqueue",e),a.removeListener("mbactive",e),a.removeListener("mbinit",e),a.removeListener("mbconnected",e),a.removeListener("mberror",e),a.removeListener("mbclosed",e)},n.updateOnAllUnitQueues?(n.registerModbusQueueActionsToNode(n.readFromAllUnitQueues),t.setNodeStatusTo("active for all queues",n)):n.registerModbusQueueActionsToNode(n.readFromQueue),n.on("input",function(e){var t,u=n.unitid,u=e.payload.resetQueue?parseInt(e.payload.unitId):parseInt(e.payload)||n.unitid;e.payload={},e.payload.queueEnabled=a.bufferCommands,n.updateOnAllUnitQueues?(e.payload.allQueueData=!0,e.payload.queues=a.bufferCommandList):(e.payload.allQueueData=!1,e.payload.unitid=u,e.payload.queue=a.bufferCommandList.get(u)),e.payload.queueOptions={date:Date.now(),state:"queue request",modbusClientName:a.name||a.id,lowlowLevel:n.lowlowLevel,unitId:u,lowLevel:n.lowLevel,highLevel:n.highLevel,highHighLevel:n.highHighLevel},(e.payload.resetQueue||e.resetQueue)&&a.bufferCommands&&(o.initQueue(a),i.settings.verbose&&(t="Init Queue By External Node",a.warn(t),s(t)),n.initUnitQueueStates(),n.showStatusActivities&&n.status({fill:"blue",shape:"ring",text:"active empty unit queue"}),e.payload.queueOptions.state="queue reset done"),n.send(e)}),n.on("close",function(e){n.updateOnAllUnitQueues?n.removeModbusQueueActionsFromNode(n.readFromAllUnitQueues):n.removeModbusQueueActionsFromNode(n.readFromQueue),t.setNodeStatusTo("closed",n),n.queueReadInterval&&clearInterval(n.queueReadInterval),n.queueReadInterval=null,a.deregisterForModbus(n.id,e)}),n.showStatusActivities||t.setNodeDefaultStatus(n))})};
//# sourceMappingURL=maps/modbus-queue-info.js.map
