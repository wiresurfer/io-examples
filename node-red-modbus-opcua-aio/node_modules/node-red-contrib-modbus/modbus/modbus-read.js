"use strict";module.exports=function(o){require("source-map-support").install();var s=require("./modbus-basics"),d=require("./core/modbus-core"),u=require("./core/modbus-io-core"),l=require("debug")("contribModbus:read");o.nodes.registerType("modbus-read",function(e){o.nodes.createNode(this,e),this.name=e.name,this.topic=e.topic,this.unitid=e.unitid,this.dataType=e.dataType,this.adr=e.adr,this.quantity=e.quantity||1,this.rate=e.rate,this.rateUnit=e.rateUnit,this.delayOnStart=e.delayOnStart,this.startDelayTime=parseInt(e.startDelayTime)||10,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.connection=null,this.useIOFile=e.useIOFile,this.ioFile=o.nodes.getNode(e.ioFile),this.useIOForPayload=e.useIOForPayload,this.logIOActivities=e.logIOActivities,this.emptyMsgOnFail=e.emptyMsgOnFail,this.internalDebugLog=l,this.verboseLogging=o.settings.verbose;var a=this,r=!1;function t(e){o.settings.verbose&&a.warn("Client -> "+e+a.serverInfo)}a.INPUT_TIMEOUT_MILLISECONDS=1e3,a.statusText="waiting",a.delayTimerReading=!1,a.intervalTimerIdReading=!1,n(a.statusText),t("open node "+a.id);var i=o.nodes.getNode(e.server);function n(e){var t,i,n,o;"polling"===e&&r||(t=s.setNodeStatusProperties(e,a.showStatusActivities),i=a.statusText,-1!==e.search("active")||"polling"===e?(n=t.status+(" ( "+a.rate+" "+s.get_timeUnit_name(a.rateUnit))+" ) ",r=!1,n!==i&&a.status({fill:t.fill,shape:t.shape,text:n})):(o=t.status)!==i&&a.status({fill:t.fill,shape:t.shape,text:o}))}i&&(a.onModbusInit=function(){n("initialized")},a.onModbusConnect=function(){n("connected"),a.resetAllReadingTimer(),a.initializeReadingTimer()},a.onModbusRegister=function(){a.showStatusActivities&&n("registered"),i.serialSendingAllowed&&(a.resetAllReadingTimer(),a.initializeReadingTimer(),n("connected"))},a.onModbusActive=function(){n("active")},a.onModbusQueue=function(){n("queue")},a.onModbusError=function(e){n("failure"),i.reconnectOnTimeout&&a.resetAllReadingTimer(),a.showErrors&&a.warn(e)},a.onModbusClose=function(){n("closed"),a.resetAllReadingTimer()},a.onModbusBroken=function(){n("broken"),i.reconnectOnTimeout&&(n("reconnecting after "+i.reconnectTimeout+" msec."),a.resetAllReadingTimer())},a.onModbusReadDone=function(e,t){a.showStatusActivities&&n("reading done"),function(e,t,i){var n=i.topic||a.topic;{var o,r,s;a.useIOFile&&a.ioFile.lastUpdatedAt?(a.logIOActivities&&u.internalDebug("node.adr:"+a.adr+" node.quantity:"+a.quantity),o=u.nameValuesFromIOFile(a,i,e,t,a.adr),r=u.filterValueNames(a,o,d.functionCodeModbusRead(a.dataType),a.adr,a.quantity),s={topic:n,responseBuffer:t,input:i,sendingNodeId:a.id},a.useIOForPayload?(s.payload=r,s.values=e):(s.payload=e,s.valueNames=r),a.send([s,{topic:n,payload:t,values:e,input:i,valueNames:r,sendingNodeId:a.id}])):a.send([{topic:n,payload:e,responseBuffer:t,input:i,sendingNodeId:a.id},{topic:n,payload:t,values:e,input:i,sendingNodeId:a.id}])}}(e.data,e,t)},a.errorProtocolMsg=function(e,t){s.logMsgError(a,e,t),s.sendEmptyMsgOnFail(a,e,t)},a.onModbusReadError=function(e,t){a.internalDebugLog(e.message),a.errorProtocolMsg(e,t),s.setModbusError(a,i,e,t)},a.modbusPollingRead=function(){var e;i.client?(e={topic:a.topic||"polling",from:a.name,payload:{unitid:a.unitid,fc:d.functionCodeModbusRead(a.dataType),address:a.adr,quantity:a.quantity,messageId:d.getObjectId()}},a.showStatusActivities&&n("polling"),i.emit("readModbus",e,a.onModbusReadDone,a.onModbusReadError)):n("waiting")},a.resetDelayTimerToRead=function(e){e.delayTimerReading&&(t("resetDelayTimerToRead node "+e.id),clearTimeout(e.delayTimerReading)),e.delayTimerReading=null},a.resetIntervalToRead=function(e){e.intervalTimerIdReading&&(t("resetIntervalToRead node "+e.id),clearInterval(e.intervalTimerIdReading)),e.intervalTimerIdReading=null},a.resetAllReadingTimer=function(){a.resetDelayTimerToRead(a),a.resetIntervalToRead(a)},a.resetAllReadingTimer(),a.startIntervalReading=function(){a.intervalTimerIdReading||(t("startIntervalReading node "+a.id),a.intervalTimerIdReading=setInterval(a.modbusPollingRead,s.calc_rateByUnit(a.rate,a.rateUnit)))},a.initializeReadingTimer=function(){a.resetAllReadingTimer(),a.delayOnStart?(t("initializeReadingTimer delay timer node "+a.id),a.delayTimerReading=setTimeout(a.startIntervalReading,a.INPUT_TIMEOUT_MILLISECONDS*a.startDelayTime)):a.startIntervalReading()},a.removeNodeListenerFromModbusClient=function(){i.removeListener("mbinit",a.onModbusInit),i.removeListener("mbqueue",a.onModbusQueue),i.removeListener("mbconnected",a.onModbusConnect),i.removeListener("mbactive",a.onModbusActive),i.removeListener("mberror",a.onModbusError),i.removeListener("mbclosed",a.onModbusClose),i.removeListener("mbbroken",a.onModbusBroken),i.removeListener("mbregister",a.onModbusRegister),i.removeListener("mbderegister",a.onModbusClose)},this.on("close",function(e){a.resetAllReadingTimer(),a.removeNodeListenerFromModbusClient(),n("closed"),t("close node "+a.id),i.deregisterForModbus(a.id,e)}),a.showStatusActivities&&(i.on("mbinit",a.onModbusInit),i.on("mbqueue",a.onModbusQueue)),i.on("mbconnected",a.onModbusConnect),i.on("mbactive",a.onModbusActive),i.on("mberror",a.onModbusError),i.on("mbclosed",a.onModbusClose),i.on("mbbroken",a.onModbusBroken),i.on("mbregister",a.onModbusRegister),i.on("mbderegister",a.onModbusClose),i.registerForModbus(a))}),o.httpAdmin.post("/modbus/read/inject/:id",o.auth.needsPermission("modbus.inject.write"),function(e,t){var i=o.nodes.getNode(e.params.id);if(i)try{i.modbusPollingRead(),t.sendStatus(200)}catch(e){t.sendStatus(500),i.error(o._("modbusinject.failed",{error:e.toString()}))}else t.sendStatus(404)})};
//# sourceMappingURL=maps/modbus-read.js.map
