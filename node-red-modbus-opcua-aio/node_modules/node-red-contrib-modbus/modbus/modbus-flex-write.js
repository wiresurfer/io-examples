"use strict";module.exports=function(a){require("source-map-support").install();var d=require("./modbus-basics"),t=require("./core/modbus-core"),s=require("debug")("contribModbus:flex:write");a.nodes.registerType("modbus-flex-write",function(e){a.nodes.createNode(this,e),this.name=e.name,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.emptyMsgOnFail=e.emptyMsgOnFail,this.keepMsgProperties=e.keepMsgProperties,this.internalDebugLog=s,this.verboseLogging=a.settings.verbose;var r=this;r.bufferMessageList=new Map,d.setNodeStatusTo("waiting",r);var i=a.nodes.getNode(e.server);i&&(i.registerForModbus(r),d.initModbusClientEvents(r,i),r.onModbusWriteDone=function(e,a){r.showStatusActivities&&d.setNodeStatusTo("writing done",r),r.send(t.buildMessage(r.bufferMessageList,a.payload,e,a)),r.emit("modbusFlexWriteNodeDone")},r.errorProtocolMsg=function(e,a){d.logMsgError(r,e,a),d.sendEmptyMsgOnFail(r,e,a)},r.onModbusWriteError=function(e,a){r.internalDebugLog(e.message);var s=t.getOriginalMessage(r.bufferMessageList,a);r.errorProtocolMsg(e,s),d.setModbusError(r,i,e,s),r.emit("modbusFlexWriteNodeError")},r.prepareMsg=function(e){return"string"==typeof e.payload&&(e.payload=JSON.parse(e.payload)),e.payload.fc=parseInt(e.payload.fc),e.payload.unitid=parseInt(e.payload.unitid),e.payload.address=parseInt(e.payload.address),e.payload.quantity=parseInt(e.payload.quantity),e},r.isValidModbusMsg=function(e){var a=!0;return Number.isInteger(e.payload.fc)&&(5===e.payload.fc||6===e.payload.fc||15===e.payload.fc||16===e.payload.fc)||(r.error("FC Not Valid",e),a&=!1),!a||Number.isInteger(e.payload.address)&&0<=e.payload.address&&e.payload.address<=65535||(r.error("Address Not Valid",e),a&=!1),!a||Number.isInteger(e.payload.quantity)&&1<=e.payload.quantity&&e.payload.quantity<=65535||(r.error("Quantity Not Valid",e),a&=!1),a},r.setMsgPayloadFromHTTPRequests=function(e){return Object.prototype.hasOwnProperty.call(e.payload,"value")&&"string"==typeof e.payload.value&&("true"===e.payload.value||"false"===e.payload.value?e.payload.value="true"===e.payload.value:-1<e.payload.value.indexOf(",")&&(e.payload.value=JSON.parse(e.payload.value))),e},r.buildNewMessageObject=function(e,a){var s=t.getObjectId();return{topic:a.topic||e.id,messageId:s,payload:{value:Object.prototype.hasOwnProperty.call(a.payload,"value")?a.payload.value:a.payload,unitid:a.payload.unitid,fc:a.payload.fc,address:a.payload.address,quantity:a.payload.quantity,messageId:s}}},r.on("input",function(e){if(!d.invalidPayloadIn(e)&&i.client){var a=Object.assign({},e);try{var s,t,o=r.prepareMsg(a);r.isValidModbusMsg(o)&&(s=r.setMsgPayloadFromHTTPRequests(o),t=r.buildNewMessageObject(r,s),r.bufferMessageList.set(t.messageId,d.buildNewMessage(r.keepMsgProperties,s,t)),i.emit("writeModbus",t,r.onModbusWriteDone,r.onModbusWriteError))}catch(e){r.errorProtocolMsg(e,a)}r.showStatusActivities&&d.setNodeStatusTo(i.actualServiceState,r)}}),r.on("close",function(e){d.setNodeStatusTo("closed",r),r.bufferMessageList.clear(),i.deregisterForModbus(r.id,e)}),r.showStatusActivities||d.setNodeDefaultStatus(r))})};
//# sourceMappingURL=maps/modbus-flex-write.js.map
